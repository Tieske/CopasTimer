<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <title>Reference</title>
    <link rel="stylesheet" href="../luadoc.css" type="text/css" />
	<!--meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/-->
</head>

<body>
<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->

<div id="main">

<div id="navigation">


<h1>LuaDoc</h1>
<ul>
	
	<li><a href="../index.html">Index</a></li>
	
</ul>


<!-- Module list -->



<!-- File list -->

<h1>Files</h1>
<ul>

	<li><strong>copastimer.lua</strong></li>
	
</ul>






</div> <!-- id="navigation" -->

<div id="content">

<h1>File <code>copastimer.lua</code></h1>


<p>Copas Timer is a module that adds a timer capability to the Copas scheduler. It provides the same base functions <code>step</code> and <code>loop</code> as Copas (it actually replaces them) except that it will also check for (and run) timers expiring and run background workers if there is no IO or timer to handle. It also adds an <code>isexiting</code> field that allows for a controlled exit from the loop.<br/>&nbsp<br/>To use the module, make sure to 'require' copastimer before any other code 'requires' copas. This will make sure that the copas version in use will updated before any other code uses it. The changes should be transparent to your existing code.<br/>&nbsp<br/>There is a difference between the 2 background mechanisms provided; the timers run on the main loop, should never yield and return quickly, but they are precise. On the other hand the workers run in their own thread (coroutine) and can be yielded if they take too long, but are less precisely timed. <br/><strong>Important:</strong> the workers should never wait for work to come in. They must exit when done. New work should create a new worker. The reason is that while there are worker threads available the luasocket <code>select</code> statement is called with a 0 timeout (non-blocking) to make sure background work is completed asap. If a worker waits for work (call <code>yield()</code> when it has nothing to do) it will create a busy-wait situation.<br/>&nbsp<br/>Copas Timer is free software under the MIT/X11 license.</p>



<p>Copyright &copy;2011 Thijs Schreijer</p>


<p><small><b>Release:</b> Version 0.4.0, Timer module to extend Copas with a timer and worker capability</small></p>



<h2>Functions</h2>
<table class="function_list">

	<tr>
	<td class="name" nowrap><a href="#copas.addworker">copas.addworker</a>&nbsp;(func, args, errhandler)</td>
	<td class="summary">Adds a worker thread.</td>
	</tr>

	<tr>
	<td class="name" nowrap><a href="#copas.cancelall">copas.cancelall</a>&nbsp;()</td>
	<td class="summary">Cancels all currently armed timers.</td>
	</tr>

	<tr>
	<td class="name" nowrap><a href="#copas.delayedexecutioner">copas.delayedexecutioner</a>&nbsp;(delay, func, ...)</td>
	<td class="summary">Calls a function delayed, after the specified amount of time.</td>
	</tr>

	<tr>
	<td class="name" nowrap><a href="#copas.isexiting">copas.isexiting</a>&nbsp;()</td>
	<td class="summary">Indicator of the loop running or exiting (it is a field, not a function!).</td>
	</tr>

	<tr>
	<td class="name" nowrap><a href="#copas.loop">copas.loop</a>&nbsp;(timeout, precision)</td>
	<td class="summary">Executes an endless loop handling Copas steps and timers  (it replaces the original <code>copas.loop()</code>).</td>
	</tr>

	<tr>
	<td class="name" nowrap><a href="#copas.newtimer">copas.newtimer</a>&nbsp;(f_arm, f_expire, f_cancel, recurring, f_error)</td>
	<td class="summary">Creates a new timer.</td>
	</tr>

	<tr>
	<td class="name" nowrap><a href="#copas.removeworker">copas.removeworker</a>&nbsp;(t)</td>
	<td class="summary">Removes a worker thread </td>
	</tr>

	<tr>
	<td class="name" nowrap><a href="#copas.step">copas.step</a>&nbsp;(timeout, precision)</td>
	<td class="summary">Executes a single Copas step followed by the execution of the first expired (if any) timer in the timers list (it replaces the original <code>copas.step()</code>) if there is no timer that expires then it will try to execute a worker step if available.</td>
	</tr>

	<tr>
	<td class="name" nowrap><a href="#t:arm">t:arm</a>&nbsp;(self, interval)</td>
	<td class="summary">Arms a previously created timer </td>
	</tr>

	<tr>
	<td class="name" nowrap><a href="#t:cancel">t:cancel</a>&nbsp;(self)</td>
	<td class="summary">Cancels a previously armed timer </td>
	</tr>

</table>






<br/>
<br/>




<h2><a name="functions"></a>Functions</h2>
<dl class="function">



<dt><a name="copas.addworker"></a><strong>copas.addworker</strong>&nbsp;(func, args, errhandler)</dt>
<dd>
Adds a worker thread. The threads will be executed when there is no IO nor any expiring timer to run. The <code>args</code> key of the returned table can be modified while the thread is still scheduled. After the <code>args</code> have been passed to <code>resume</code> the <code>args</code> will be set to <code>nil</code>. If <code>args</code> is set again, then the next time the thread is up to run, the new set of <code>args</code> will be passed on to the thread. This enables feeding the thread with data.


<h3>Parameters:</h3>
<ul>
	
	<li>
	  <code><em>func</em></code>: function to execute in the coroutine
	</li>
	
	<li>
	  <code><em>args</em></code>: table with arguments for the function
	</li>
	
	<li>
	  <code><em>errhandler</em></code>: function to handle any errors returned
	</li>
	
</ul>






<h3>Return value:</h3>
<ul>table with keys <code>thread, args, errhandler</code></ul>



<h3>See also:</h3>
<ul>
	
	<!-- <li><a href="#../files/copastimer.html#copas.removeworkercopas.removeworker"> -->
	<li><a href="#copas.removeworker">
		copas.removeworker</li>
	</a>
	
</ul>

</dd>




<dt><a name="copas.cancelall"></a><strong>copas.cancelall</strong>&nbsp;()</dt>
<dd>
Cancels all currently armed timers. Call this method after exiting the loop, to make sure all timers are properly cancelled and their cancel callback methods have been executed.









</dd>




<dt><a name="copas.delayedexecutioner"></a><strong>copas.delayedexecutioner</strong>&nbsp;(delay, func, ...)</dt>
<dd>
Calls a function delayed, after the specified amount of time. An example use is a call that requires communications to be running already, but if you start the Copas loop, it basically blocks; classic chicken-egg. In this case use the <code>delayedexecutioner</code> to call the method in 0.5 seconds, just before starting the CopasTimer loop. Now when the method actually executes, communications will be online already. The internals use a timer, so it is executed on the main loop and should not be suspended by calling <code>yield()</code>.


<h3>Parameters:</h3>
<ul>
	
	<li>
	  <code><em>delay</em></code>: delay in seconds before calling the function
	</li>
	
	<li>
	  <code><em>func</em></code>: function to call
	</li>
	
	<li>
	  <code><em>...</em></code>: any arguments to be passed to the function
	</li>
	
</ul>








<h3>See also:</h3>
<ul>
	
	<!-- <li><a href="#../files/copastimer.html#copas.newtimercopas.newtimer"> -->
	<li><a href="#copas.newtimer">
		copas.newtimer</li>
	</a>
	
</ul>

</dd>




<dt><a name="copas.isexiting"></a><strong>copas.isexiting</strong>&nbsp;()</dt>
<dd>
Indicator of the loop running or exiting (it is a field, not a function!). Possible values; <ul> <li><code>nil</code>: the loop is not running, </li> <li><code>false</code>: the loop is running, or </li> <li><code>true</code>: the loop is scheduled to stop after the current iteration.</li></ul>





<h3>Usage:</h3>
<ul><pre class=example>if copas.isexiting ~= nil then<br/>&nbsp&nbsp&nbsp&nbsp-- loop is currently running, make it exit after the next iteration<br/>&nbsp&nbsp&nbsp&nbspcopas.isexiting = true<br/>end</pre></ul>





<h3>See also:</h3>
<ul>
	
	<!-- <li><a href="#../files/copastimer.html#copas.loopcopas.loop"> -->
	<li><a href="#copas.loop">
		copas.loop</li>
	</a>
	
</ul>

</dd>




<dt><a name="copas.loop"></a><strong>copas.loop</strong>&nbsp;(timeout, precision)</dt>
<dd>
Executes an endless loop handling Copas steps and timers  (it replaces the original <code>copas.loop()</code>). The loop can be terminated by setting <code>isexiting</code> to true. When exiting the loop, consider call <code>cancelall()</code> to make sure all armed timers get properly cancelled and their <code>cancel</code> callbacks get called properly.


<h3>Parameters:</h3>
<ul>
	
	<li>
	  <code><em>timeout</em></code>: time out (in seconds) to be used. The timer list will be checked at least every <code>timeout</code> period for expired timers. The actual interval will be between <code>0</code> and <code>timeout</code> based on the next timers expire time or worker threads being available. If not provided, it defaults to 5 seconds.
	</li>
	
	<li>
	  <code><em>precision</em></code>: the precision of the timer (in seconds). Whenever the timer list is checked for expired timers, a timer is considered expired when the exact expire time is in the past or up to <code>precision</code> seconds in the future. It defaults to 0.02 if not provided.
	</li>
	
</ul>








<h3>See also:</h3>
<ul>
	
	<!-- <li><a href="#../files/copastimer.html#copas.stepcopas.step"> -->
	<li><a href="#copas.step">
		copas.step</li>
	</a>
	
	<!-- <li><a href="#../files/copastimer.html#copas.isexitingcopas.isexiting"> -->
	<li><a href="#copas.isexiting">
		copas.isexiting</li>
	</a>
	
</ul>

</dd>




<dt><a name="copas.newtimer"></a><strong>copas.newtimer</strong>&nbsp;(f_arm, f_expire, f_cancel, recurring, f_error)</dt>
<dd>
Creates a new timer. After creating call the <code>arm</code> method of the new timer to actually schedule it. REMARK: the background workers run in their own thread (coroutine) and hence need to <code>yield</code> when their operation takes to long, but the timers run on the main loop, and hence the callbacks should never <code>yield()</code>, in those cases consider adding a worker through <code>copas.addworker()</code> from the timer callback.


<h3>Parameters:</h3>
<ul>
	
	<li>
	  <code><em>f_arm</em></code>: callback function to execute when the timer is armed
	</li>
	
	<li>
	  <code><em>f_expire</em></code>: callback function to execute when the timer expires
	</li>
	
	<li>
	  <code><em>f_cancel</em></code>: callback function to execute when the timer is cancelled
	</li>
	
	<li>
	  <code><em>recurring</em></code>: (boolean) should the timer automatically be re-armed with the same interval after it expired
	</li>
	
	<li>
	  <code><em>f_error</em></code>: callback function to execute when any of the other callbacks generates an error
	</li>
	
</ul>




<h3>Usage:</h3>
<ul><pre class=example>-- Create a new timer<br/>local t = copas.newtimer(nil, function () print("hello world") end, nil, false, nil)<br/>&nbsp;<br/>-- Create timer and arm it immediately, to be run in 5 seconds<br/>copas.newtimer(nil, function () print("hello world") end, nil, false, nil):arm(5)<br/>&nbsp;<br/>-- Create timer and arm it immediately, to be run now (function f is provide twice!) and again every 5 seconds<br/>local f = function () print("hello world") end<br/>copas.newtimer(f, f, nil, true, nil):arm(5)</pre></ul>





<h3>See also:</h3>
<ul>
	
	<!-- <li><a href="#../files/copastimer.html#t:armt:arm"> -->
	<li><a href="#t:arm">
		t:arm</li>
	</a>
	
	<!-- <li><a href="#../files/copastimer.html#t:cancelt:cancel"> -->
	<li><a href="#t:cancel">
		t:cancel</li>
	</a>
	
	<!-- <li><a href="#../files/copastimer.html#copas.cancelallcopas.cancelall"> -->
	<li><a href="#copas.cancelall">
		copas.cancelall</li>
	</a>
	
</ul>

</dd>




<dt><a name="copas.removeworker"></a><strong>copas.removeworker</strong>&nbsp;(t)</dt>
<dd>
Removes a worker thread


<h3>Parameters:</h3>
<ul>
	
	<li>
	  <code><em>t</em></code>: thread table (as returned by <code>copas.addworker()</code>), or actual thread to be removed.
	</li>
	
</ul>






<h3>Return value:</h3>
<ul><code>true</code> if success or <code>false</code> if it wasn't found</ul>



<h3>See also:</h3>
<ul>
	
	<!-- <li><a href="#../files/copastimer.html#copas.addworkercopas.addworker"> -->
	<li><a href="#copas.addworker">
		copas.addworker</li>
	</a>
	
</ul>

</dd>




<dt><a name="copas.step"></a><strong>copas.step</strong>&nbsp;(timeout, precision)</dt>
<dd>
Executes a single Copas step followed by the execution of the first expired (if any) timer in the timers list (it replaces the original <code>copas.step()</code>) if there is no timer that expires then it will try to execute a worker step if available.


<h3>Parameters:</h3>
<ul>
	
	<li>
	  <code><em>timeout</em></code>: timeout value (in seconds) to pass to the Copas step handler
	</li>
	
	<li>
	  <code><em>precision</em></code>: see parameter <code>precision</code> at function <code>loop()</code>.
	</li>
	
</ul>






<h3>Return value:</h3>
<ul>time in seconds until the next timer in the list expires, or <code>nil</code> if there is none.</ul>



<h3>See also:</h3>
<ul>
	
	<!-- <li><a href="#../files/copastimer.html#copas.loopcopas.loop"> -->
	<li><a href="#copas.loop">
		copas.loop</li>
	</a>
	
</ul>

</dd>




<dt><a name="t:arm"></a><strong>t:arm</strong>&nbsp;(self, interval)</dt>
<dd>
Arms a previously created timer


<h3>Parameters:</h3>
<ul>
	
	<li>
	  <code><em>self</em></code>: 
	</li>
	
	<li>
	  <code><em>interval</em></code>: the interval after which the timer expires (in seconds)
	</li>
	
</ul>




<h3>Usage:</h3>
<ul><pre class=example>-- Create a new timer<br/>local t = copas.newtimer(nil, function () print("hello world") end, nil, false)<br/>t:arm(5)              -- arm it at 5 seconds<br/>t:cancel()            -- cancel it again</pre></ul>



<h3>Return value:</h3>
<ul>the timer <code>t</code></ul>



<h3>See also:</h3>
<ul>
	
	<!-- <li><a href="#../files/copastimer.html#t:cancelt:cancel"> -->
	<li><a href="#t:cancel">
		t:cancel</li>
	</a>
	
	<!-- <li><a href="#../files/copastimer.html#copas.newtimercopas.newtimer"> -->
	<li><a href="#copas.newtimer">
		copas.newtimer</li>
	</a>
	
</ul>

</dd>




<dt><a name="t:cancel"></a><strong>t:cancel</strong>&nbsp;(self)</dt>
<dd>
Cancels a previously armed timer


<h3>Parameters:</h3>
<ul>
	
	<li>
	  <code><em>self</em></code>: 
	</li>
	
</ul>




<h3>Usage:</h3>
<ul><pre class=example>-- Create a new timer<br/>local t = copas.newtimer(nil, function () print("hello world") end, nil, false)<br/>t:arm(5)              -- arm it at 5 seconds<br/>t:cancel()            -- cancel it again</pre></ul>





<h3>See also:</h3>
<ul>
	
	<!-- <li><a href="#../files/copastimer.html#t:armt:arm"> -->
	<li><a href="#t:arm">
		t:arm</li>
	</a>
	
	<!-- <li><a href="#../files/copastimer.html#copas.newtimercopas.newtimer"> -->
	<li><a href="#copas.newtimer">
		copas.newtimer</li>
	</a>
	
</ul>

</dd>


</dl>







</div> <!-- id="content" -->

</div> <!-- id="main" -->

<div id="about">
	<p><a href="http://validator.w3.org/check?uri=referer"><img src="http://www.w3.org/Icons/valid-xhtml10" alt="Valid XHTML 1.0!" height="31" width="88" /></a></p>
</div> <!-- id="about" -->

</div> <!-- id="container" -->	
</body>
</html>
